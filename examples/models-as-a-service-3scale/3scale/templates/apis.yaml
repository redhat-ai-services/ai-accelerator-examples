{{- range .Values.apis }}
---
apiVersion: capabilities.3scale.net/v1beta1
kind: Backend
metadata:
  name: {{ .name }}
  namespace: {{ $.Values.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "4"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  labels:
    {{- include "3scale.labels" . | nindent 4 }}
spec:
  name: "{{ .name }}"
  systemName: "{{ .name }}"
  privateBaseURL: "{{ .backend.privateBaseURL }}"
  providerAccountRef:
    name: 3scale-maas-tenant-secret
---
apiVersion: capabilities.3scale.net/v1beta1
kind: Product
metadata:
  name: {{ .name }}
  namespace: {{ $.Values.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  labels:
    {{- include "3scale.labels" . | nindent 4 }}
spec:
  name: "{{ .name }}"
  systemName: "{{ .name }}"
  backendUsages:
    {{ .name }}:
      path: {{ .backend.path }}
  {{- $sections := dict
    "deployment" .deployment
    "policies" .policies
    "metrics" .metrics
    "methods" .methods
    "mappingRules" .mappingRules
  -}}
  {{- range $key, $value := $sections }}
  {{- if $value }}
  {{ $key }}:
    {{- toYaml $value | nindent 4 }}
  {{- end }}
  {{- end }}
  applicationPlans:
    standard:
      name: "Standard Plan"
      {{- if .applicationPlans.standard.appsRequireApproval }}
      appsRequireApproval: {{ .applicationPlans.standard.appsRequireApproval }}
      {{- end }}
      published: true
  providerAccountRef:
    name: 3scale-maas-tenant-secret
---
# The 3scale operator is not evaluating the `skipSwagValidator` flag.
# Validate the API definition here: https://editor.swagger.io
# See https://issues.redhat.com/browse/THREESCALE-11842 for more details
apiVersion: capabilities.3scale.net/v1beta1
kind: ActiveDoc
metadata:
  name: {{ .name }}
  namespace: {{ $.Values.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "6"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  labels:
    {{- include "3scale.labels" . | nindent 4 }}
spec:
  name: "{{ .name }}"
  systemName: {{ include "3scale.systemName" .name }}
  activeDocOpenAPIRef:
{{- if .activeDocOpenAPIRefUrl }}
    url: {{ .activeDocOpenAPIRefUrl }}
{{- else }}
    secretRef:
      name: {{ .name }}-activedoc
{{- end }}
  skipSwaggerValidations: true
  productSystemName: {{ .name }}
  published: true
  providerAccountRef:
    name: 3scale-maas-tenant-secret
---
{{- $activeDocOpenAPIFile := .activeDocOpenAPIFile | default "" }}
{{- if $activeDocOpenAPIFile }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .name }}-activedoc
  namespace: {{ $.Values.namespace }}
  labels:
    {{- include "3scale.labels" . | nindent 4 }}
type: Opaque
data:
{{- if eq (trimSuffix ".json" $activeDocOpenAPIFile) $activeDocOpenAPIFile }}
  openapi.json: '{{ .Files.Get .activeDocOpenAPIFile | b64enc }}'
{{- else }}
  openapi.yaml: '{{ .Files.Get .activeDocOpenAPIFile | b64enc }}'
{{- end }}
{{- end }}
---
apiVersion: capabilities.3scale.net/v1beta1
kind: ProxyConfigPromote
metadata:
  name: {{ .name }}
  namespace: {{ $.Values.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "9"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  labels:
    {{- include "3scale.labels" . | nindent 4 }}
spec:
  productCRName: {{ .name }}
  production: true
  deleteCR: false
{{- end }}
